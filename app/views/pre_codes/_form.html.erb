<!-- app/views/pre_codes/_form.html.erb -->
<%= render "shared/errors", object: pre_code %>

<%
  # 管理側から呼ばれたときだけ admin ネームスペースに送る
  admin_namespace = (local_assigns[:namespace] == :admin)
  form_model      = admin_namespace ? [:admin, pre_code] : pre_code
%>

<%= form_with model: form_model, class: "space-y-6" do |f| %>
  <div data-controller="precode-mode"
       data-precode-mode-mode-value="normal"
       class="space-y-6">

    <!-- モードの現在値を送る hidden -->
    <%= f.hidden_field :quiz_mode,
          value: "false",
          data: { "precode-mode-target": "modeField" } %>

    <div class="flex items-center justify-end">
      <button type="button"
              class="px-3 py-1 rounded ring-1 ring-slate-300 text-sm"
              data-precode-mode-target="toggle"
              data-action="precode-mode#switch">
        問題モードにする
      </button>
    </div>

    <!-- タイトル -->
    <div class="space-y-2">
      <label class="block text-sm font-semibold text-slate-500"
             data-precode-mode-target="titleLabel">登録名</label>
      <%= f.text_field :title,
            placeholder: "選択肢に表示する名前を入力してください",
            class: "w-full rounded-xl ring-1 ring-slate-300 px-3 py-2 focus:ring-slate-500" %>
    </div>

    <!-- タグ -->
    <div class="space-y-2">
      <label class="block text-sm font-semibold text-slate-500">タグ（最大10個）</label>
      <input id="tag-input" name="tag_names" value="<%= pre_code.tags.map(&:name).join(',') %>"
             class="w-full rounded-xl ring-1 ring-slate-300 px-3 py-2"
             placeholder="例: ruby, array, sql"
             data-controller="tag-token"
             data-action="input->tag-token#suggest">
      <div id="tag-suggest" class="text-sm text-slate-500"></div>
    </div>

    <!-- 説明（通常モードの“問題文”相当） -->
    <div class="space-y-2">
      <label class="block text-sm font-semibold text-slate-500"
             data-precode-mode-target="descLabel">コードの説明</label>
      <%= f.text_area :description, rows: 3,
            placeholder: "コード内容の説明を簡単に書いてください",
            class: "w-full rounded-xl ring-1 ring-slate-300 px-3 py-2",
            data: {
              controller: "autosize",
              "autosize-target": "field",
              "autosize-min-rows-value": 3
            } %>
    </div>

    <!-- ▼ ヒント（問題モード時のみ表示） -->
    <div data-precode-mode-target="quizBlock" class="space-y-2 hidden">
      <label class="block text-sm font-semibold text-slate-500">ヒント（任意）</label>
      <%= f.text_area :hint, rows: 3,
            placeholder: "ヒント本文（1000文字まで）",
            class: "w-full rounded-xl ring-1 ring-slate-300 px-3 py-2",
            data: {
              controller: "autosize",
              "autosize-target": "field",
              "autosize-min-rows-value": 3
            } %>
    </div>

    <!-- ▼ 登録コード（常に表示） -->
    <div class="space-y-2">
      <label class="block text-sm font-semibold text-slate-500">登録コード</label>
      <style>.cm-editor,.cm-scroller{background:transparent!important}</style>
      <div data-controller="precode-body" data-precode-body-theme-value="light"
           class="rounded-xl ring-1 ring-slate-300 overflow-hidden">
        <%= f.text_area :body, data: { "precode-body-target": "field" }, class: "hidden" %>
        <div data-precode-body-target="mount" class="w-full min-h-[300px]"></div>
      </div>
    </div>

    <!-- ▼ 解答（問題モード時のみ表示） -->
    <div data-precode-mode-target="quizBlock" class="space-y-2 hidden">
      <label class="block text-sm font-semibold text-slate-500">解答（必須）</label>
      <%= f.text_area :answer, rows: 4,
            placeholder: "解答本文（2000文字まで）",
            class: "w-full rounded-xl ring-1 ring-slate-300 px-3 py-2",
            data: {
              controller: "autosize",
              "autosize-target": "field",
              "autosize-min-rows-value": 4,
              "precode-mode-target": "answerField"
            } %>

      <div class="space-y-2">
        <label class="block text-sm font-semibold text-slate-500">解答用コード（任意）</label>
        <style>.cm-editor,.cm-scroller{background:transparent!important}</style>
        <div data-controller="precode-body" data-precode-body-theme-value="light"
             class="rounded-xl ring-1 ring-slate-300 overflow-hidden">
          <%= f.text_area :answer_code,
                data: { "precode-body-target": "field",
                        "precode-mode-target": "answerCodeField" },
                class: "hidden" %>
          <div data-precode-body-target="mount" class="w-full min-h-[200px]"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex justify-center">
    <%= f.submit (pre_code.new_record? ? "登録" : "更新"),
          class: "inline-flex justify-center w-64 bg-[#CC0000] text-white px-4 py-2 rounded hover:bg-[#BB0000] active:bg-[#AA0000]" %>
  </div>
<% end %>
