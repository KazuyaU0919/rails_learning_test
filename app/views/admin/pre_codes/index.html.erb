<% content_for :title, "PreCode管理" %>

<h1 class="text-xl font-semibold text-slate-900 mb-4">PreCode 管理</h1>

<%= form_with url: admin_pre_codes_path, method: :get, local: true, class: "mb-6" do %>
  <div class="flex flex-wrap gap-3">
    <%= text_field_tag :title, params[:title], placeholder: "タイトルを部分一致検索",
        class: "w-64 rounded-md border border-slate-300 px-3 py-2 text-sm" %>
    <%= text_field_tag :description, params[:description], placeholder: "説明を部分一致検索",
        class: "w-72 rounded-md border border-slate-300 px-3 py-2 text-sm" %>
    <%= text_field_tag :user, params[:user], placeholder: "ユーザー名/メール",
        class: "w-64 rounded-md border border-slate-300 px-3 py-2 text-sm" %>

    <% if PreCode.reflect_on_association(:tags) %>
      <%= select_tag :tag_ids,
          options_from_collection_for_select(Tag.order(:name), :id, :name, Array(params[:tag_ids])),
          multiple: true, class: "min-w-[12rem] rounded-md border border-slate-300 px-3 py-2 text-sm" %>
    <% end %>

    <%= select_tag :sort,
        options_for_select([["作成日(新しい順)", ""], ["いいね数", "likes"], ["利用数", "used"], ["タイトル昇順", "title"]], params[:sort]),
        class: "rounded-md border border-slate-300 px-3 py-2 text-sm" %>

    <%= submit_tag "検索", class: "rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800" %>
  </div>
<% end %>

<div class="overflow-x-auto rounded-lg ring-1 ring-slate-200 bg-white">
  <table class="min-w-full divide-y divide-slate-200">
    <thead class="bg-slate-50 text-xs text-slate-600">
      <tr>
        <th class="px-3 py-2 text-left"><input type="checkbox" disabled></th>
        <th class="px-3 py-2 text-left">タイトル</th>
        <th class="px-3 py-2 text-left">説明(100字)</th>
        <% if PreCode.reflect_on_association(:tags) %><th class="px-3 py-2 text-left">タグ</th><% end %>
        <th class="px-3 py-2 text-left">ユーザー</th>
        <th class="px-3 py-2 text-right">いいね</th>
        <th class="px-3 py-2 text-right">利用</th>
        <th class="px-3 py-2 text-left">作成日</th>
        <th class="px-3 py-2 text-left">操作</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-slate-100 text-sm">
      <% @pre_codes.each do |p| %>
        <tr class="hover:bg-slate-50/60">
          <td class="px-3 py-2"><input type="checkbox" disabled></td>
          <td class="px-3 py-2 font-medium"><%= p.title %></td>
          <td class="px-3 py-2 text-slate-600"><%= truncate(p.description.to_s, length: 100) %></td>
          <% if PreCode.reflect_on_association(:tags) %>
            <td class="px-3 py-2">
              <div class="flex flex-wrap gap-1">
                <% p.tags&.each do |t| %>
                  <span class="rounded bg-slate-100 px-2 py-0.5 text-[11px] text-slate-700"><%= t.name %></span>
                <% end %>
              </div>
            </td>
          <% end %>
          <td class="px-3 py-2"><%= p.user&.name %></td>
          <td class="px-3 py-2 text-right tabular-nums"><%= p.like_count %></td>
          <td class="px-3 py-2 text-right tabular-nums"><%= p.use_count %></td>
          <td class="px-3 py-2"><%= l(p.created_at, format: :short) %></td>
          <td class="px-3 py-2">
            <div class="flex flex-wrap gap-2">
              <%= link_to "詳細", [:admin, p], class: "text-sky-700 hover:underline" %>
              <%= link_to "編集", [:edit, :admin, p], class: "text-sky-700 hover:underline" %>
              <%= link_to "削除", [:admin, p],
                    data: { turbo_method: :delete, turbo_confirm: "この初期データを削除します（復元不可）。よろしいですか？" },
                    class: "text-rose-700 hover:underline" %>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <% if @pre_codes.blank? %>
    <div class="p-6 text-center text-sm text-slate-500">該当するデータが見つかりませんでした。</div>
  <% end %>
</div>

<div class="mt-6">
  <%= paginate @pre_codes %>
</div>
