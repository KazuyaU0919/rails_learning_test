<% breadcrumb :admin_pre_codes %>
<%= render "shared/breadcrumbs" %>

<% content_for :title, "PreCode管理" %>

<h1 class="text-xl font-semibold text-slate-900 mb-4">PreCode 管理</h1>

<%= form_with url: admin_pre_codes_path, method: :get, local: true, class: "mb-6" do %>
  <div class="flex flex-wrap items-end gap-2 md:gap-3">

    <%= text_field_tag :title, params[:title],
          placeholder: "タイトルを部分一致検索",
          class: "min-w-[12rem] w-64 md:w-72 rounded-md border ring-1 ring-slate-300 px-3 py-2 text-sm" %>

    <%= text_field_tag :description, params[:description],
          placeholder: "説明を部分一致検索",
          class: "min-w-[12rem] w-72 rounded-md border ring-1 ring-slate-300 px-3 py-2 text-sm" %>

    <%= text_field_tag :user, params[:user],
          placeholder: "ユーザー名／メール",
          class: "min-w-[12rem] w-64 rounded-md border ring-1 ring-slate-300 px-3 py-2 text-sm" %>

    <%# --- タグ（一般側と同じ“タグピッカー”） --- %>
    <div class="ml-auto flex items-center gap-2"
         data-controller="tag-picker"
         data-tag-picker-fetch-url-value="/tags/popular.json"
         data-tag-picker-mode-value="filter">

      <label class="text-xs text-slate-500 mb-2">タグ</label>

      <!-- 選択済み（見た目だけ。送信は hidden で） -->
      <div data-tag-picker-target="selectedArea" class="min-h-[1.75rem]"></div>

      <!-- hidden（タグ名のカンマ区切り）※同じ form 内 -->
      <input type="hidden" name="tags" value="<%= params[:tags].to_s %>"
             data-tag-picker-target="hiddenInput">

      <button type="button" class="px-3 py-2 rounded ring-1 ring-slate-300"
              data-action="tag-picker#open">
        タグを選ぶ
      </button>

      <%= select_tag :sort,
            options_for_select(
              [["作成日(新しい順)", ""],
               ["いいね数", "likes"],
               ["利用数", "used"],
               ["タイトル昇順", "title"]],
              params[:sort]
            ),
            class: "rounded-md border ring-1 ring-slate-300 px-3 py-2 text-sm" %>

      <%= submit_tag "検索",
            class: "rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800" %>

      <!-- モーダル（一般側と同じUI：×はHeroicon、閉じるは中央・ホバー赤） -->
      <div class="hidden fixed inset-0 z-50 grid place-items-center bg-black/40"
           data-tag-picker-target="container">
        <div class="relative w-11/12 max-w-2xl rounded-2xl bg-white p-5 shadow-lg text-slate-900">
          <!-- 右上 × -->
          <button type="button"
                  class="absolute right-4 top-4 text-slate-500 hover:text-slate-700"
                  data-action="tag-picker#close" aria-label="閉じる">
            <%= heroicon "x-mark", variant: :solid, options: { class: "w-6 h-6" } %>
          </button>

          <div class="mb-3">
            <h3 class="font-semibold">タグを選択（検索）</h3>
          </div>

          <input type="text" placeholder="タグ名で絞り込み"
                 class="w-full rounded ring-1 ring-slate-300 px-3 py-2 mb-3"
                 data-tag-picker-target="query"
                 data-action="input->tag-picker#queryInput">

          <div data-tag-picker-target="list" class="max-h-[50vh] overflow-auto"></div>

          <div class="mt-4 flex justify-center">
            <button type="button"
                    class="inline-flex items-center justify-center px-6 py-2 rounded-full ring-1 ring-[#CC0000] text-[#CC0000] bg-white hover:bg-[#CC0000] hover:text-white active:bg-[#FFD6FF] transition-colors"
                    data-action="tag-picker#close">
              閉じる
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<div class="overflow-x-auto rounded-lg ring-1 ring-slate-200 bg-white">
  <table class="min-w-full divide-y divide-slate-200">
    <thead class="bg-slate-50 text-xs text-slate-600">
      <tr>
        <%# チェックボックス列は不要なので削除 %>
        <th class="px-3 py-2 text-left">タイトル</th>
        <th class="px-3 py-2 text-left">説明(100字)</th>
        <% if PreCode.reflect_on_association(:tags) %><th class="px-3 py-2 text-left">タグ</th><% end %>
        <th class="px-3 py-2 text-left">ユーザー</th>
        <th class="px-3 py-2 text-right">いいね</th>
        <th class="px-3 py-2 text-right">利用</th>
        <th class="px-3 py-2 text-left">作成日</th>
        <th class="px-3 py-2 text-left">操作</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-slate-100 text-sm">
      <% @pre_codes.each do |p| %>
        <tr class="hover:bg-slate-50/60">
          <%# チェックボックス列削除に伴い先頭TDも削除 %>
          <td class="px-3 py-2 font-medium"><%= p.title %></td>
          <td class="px-3 py-2 text-slate-600"><%= truncate(p.description.to_s, length: 100) %></td>
          <% if PreCode.reflect_on_association(:tags) %>
            <td class="px-3 py-2">
              <div class="flex flex-wrap gap-1">
                <% p.tags&.each do |t| %>
                  <span class="rounded bg-slate-100 px-2 py-0.5 text-[11px] text-slate-700"><%= t.name %></span>
                <% end %>
              </div>
            </td>
          <% end %>
          <td class="px-3 py-2"><%= p.user&.name %></td>
          <td class="px-3 py-2 text-right tabular-nums"><%= p.like_count %></td>
          <td class="px-3 py-2 text-right tabular-nums"><%= p.use_count %></td>
          <td class="px-3 py-2"><%= l(p.created_at, format: :short) %></td>
          <td class="px-3 py-2">
            <div class="flex flex-wrap gap-2">
              <%= link_to "詳細", [:admin, p], class: "text-sky-700 hover:underline" %>
              <%= link_to "編集", [:edit, :admin, p], class: "text-sky-700 hover:underline" %>
              <%= link_to "削除", [:admin, p],
                    data: { turbo_method: :delete, turbo_confirm: "この初期データを削除します（復元不可）。よろしいですか？" },
                    class: "text-rose-700 hover:underline" %>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <% if @pre_codes.blank? %>
    <div class="p-6 text-center text-sm text-slate-500">該当するデータが見つかりませんでした。</div>
  <% end %>
</div>

<div class="mt-6">
  <%= paginate @pre_codes %>
</div>
