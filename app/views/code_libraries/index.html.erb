<%# app/views/code_libraries/index.html.erb %>
<% breadcrumb :code_libraries %>
<%= render "shared/breadcrumbs" %>

<%# ページ <title> 用（SEO等） %>
<% content_for :title, "Code Library" %>

<%# ===== ヘッダーブロック：中央にタイトル、その“下の行”に右寄せの検索群 ===== %>
<div class="mb-6">

  <%# 中央タイトル %>
  <div class="text-center">
    <h1 class="text-2xl font-semibold">Code Library</h1>
    <p class="mt-1 text-sm text-slate-500">~ 初期データ閲覧機能 ~</p>
  </div>

  <%# タイトルの下の行：右寄せで検索フォーム＆使い方 %>
  <div class="mt-4">
    <div class="flex gap-2 justify-end">
      <%= search_form_for @q, url: code_libraries_path, method: :get,
            html: { class: "flex gap-2" } do |f| %>
        <%= f.search_field :title_or_description_cont,
              value: @q.title_or_description_cont,
              placeholder: "検索（タイトル／説明）",
              class: "px-3 py-2 rounded ring-1 ring-slate-300 min-w-0 w-40 sm:w-56 md:w-72 lg:w-80" %>

        <%= select_tag :sort,
              options_for_select(
                [["人気順", "popular"], ["利用数順", "used"], ["新着順", "newest"]],
                params[:sort].presence || "popular"
              ),
              class: "px-3 py-2 rounded ring-1 ring-slate-300" %>

        <%= f.submit "検索",
              class: "px-3 py-2 rounded bg-[#CC0000] text-white hover:bg-[#BB0000] active:bg-[#AA0000]" %>
      <% end %>
    </div>

    <div class="flex mt-2 justify-end">
      <%= link_to "使い方", help_path,
            class: "px-3 py-2 rounded bg-[#CC0000] text-white hover:bg-[#BB0000] active:bg-[#AA0000]" %>
    </div>
  </div>
</div>

<%# --- 一覧 --- %>
<% if @pre_codes.blank? %>
  <p class="text-slate-500">該当するデータがありません。</p>
<% else %>
  <ul class="space-y-3 -mt-2">
    <% @pre_codes.each do |pc| %>
      <li class="relative border rounded-xl p-4 group">
        <%# 透明の全体リンク（カード全面） %>
        <%= link_to code_library_path(pc),
              class: "absolute inset-0 rounded-xl focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300",
              "aria-label": "#{pc.title} の詳細" do %>
        <% end %>

        <%# 上段：タイトル/説明 + 右上メトリクス %>
        <div class="flex justify-between">
          <div class="flex-1 pr-4">
            <div class="font-semibold"><%= pc.title %></div>
            <p class="text-sm text-slate-500 mt-1"><%= truncate(pc.description, length: 100) %></p>
          </div>
          <div class="shrink-0">
            <%= render "metrics", pre_code: pc %>
          </div>
        </div>

        <%# 下段：アクション（※ここが肝） - 上の透明リンクを拾わない %>
        <div class="mt-3 flex items-center gap-2 pointer-events-none">
          <div class="pointer-events-auto z-20">
            <%= render "actions",
                  pre_code: pc,
                  current_like: (logged_in? ? pc.likes.find_by(user_id: current_user.id) : nil) %>
          </div>
        </div>
      </li>
    <% end %>
  </ul>

  <%# ページネーション（検索条件を保持して遷移） %>
  <div class="mt-6">
    <%= paginate @pre_codes, params: request.query_parameters %>
  </div>
<% end %>
