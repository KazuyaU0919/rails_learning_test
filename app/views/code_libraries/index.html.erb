<!-- app/views/code_libraries/index.html.erb -->
<% breadcrumb :code_libraries %>
<%= render "shared/breadcrumbs" %>

<% content_for :title, "コードライブラリ" %>

<div class="mb-4 space-y-3">
  <!-- 見出し -->
  <div>
    <h1 class="text-xl font-semibold"><%= yield :title %></h1>
  </div>

  <!-- 検索フォーム（Ransack） -->
  <div>
    <%= search_form_for @q, url: code_libraries_path, method: :get, html: { class: "flex gap-2" } do |f| %>
      <%= f.search_field :title_or_description_cont,
            value: @q.title_or_description_cont,
            placeholder: "キーワード",
            class: "px-3 py-2 rounded ring-1 ring-slate-300 w-64 md:w-80" %>

      <%= select_tag :sort,
            options_for_select(
              [["人気順", "popular"], ["利用数順", "used"], ["新着順", "newest"]],
              params[:sort].presence || "popular"
            ),
            class: "px-3 py-2 rounded ring-1 ring-slate-300" %>

      <%= f.submit "検索", class: "px-3 py-2 rounded bg-slate-900 text-white" %>
    <% end %>
  </div>
</div>

<%# --- 一覧 --- %>
<% if @pre_codes.blank? %>
  <p class="text-slate-500">該当するデータがありません。</p>
<% else %>
  <ul class="space-y-3">
    <% @pre_codes.each do |pc| %>
      <li class="border rounded-xl p-4">
        <div class="flex justify-between">
          <!-- ← カードの“本文側”を丸ごとリンク化 -->
          <%= link_to code_library_path(pc), class: "block flex-1 pr-4 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-300 rounded-lg" do %>
            <div class="font-semibold"><%= pc.title %></div>
            <p class="text-sm text-slate-500 mt-1"><%= truncate(pc.description, length: 100) %></p>
          <% end %>

          <!-- 右側：メトリクスやボタン（リンクの外） -->
          <div class="text-sm text-slate-500 shrink-0">
            <span class="inline-flex items-center gap-1 mr-4 align-middle">
              <%= heroicon "heart", variant: :solid, options: { class: "w-4 h-4" } %>
              <%= pc.like_count %>
            </span>
            <span class="inline-flex items-center gap-1 align-middle">
              <%= heroicon "briefcase", variant: :outline, options: { class: "w-4 h-4" } %>
              <%= pc.use_count %>
            </span>
          </div>
        </div>

        <div class="mt-3">
          <% current_like = logged_in? ? pc.likes.find_by(user_id: current_user.id) : nil %>
          <%= render "actions", pre_code: pc, current_like: current_like %>
        </div>
      </li>
    <% end %>
  </ul>

  <!-- ページネーション（検索条件を保持して遷移） -->
  <div class="mt-6">
    <%= paginate @pre_codes, params: request.query_parameters %>
  </div>
<% end %>
