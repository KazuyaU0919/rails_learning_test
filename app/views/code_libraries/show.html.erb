<%# app/views/code_libraries/show.html.erb %>
<% breadcrumb :code_libraries %>
<% breadcrumb :code_library, @pre_code %>
<%= render "shared/breadcrumbs" %>

<% content_for :title, @pre_code.title %>

<%# 先に一度だけ計算して使い回す %>
<% current_like      = logged_in? ? @pre_code.likes.find_by(user_id: current_user.id)       : nil %>
<% current_bookmark  = logged_in? ? @pre_code.bookmarks.find_by(user_id: current_user.id)   : nil %>

<div class="mx-auto w-full max-w-2xl space-y-8">

  <%# ===== 右上：いいね & ブックマーク ===== %>
  <div class="flex justify-end">
    <%= render "code_libraries/actions",
          pre_code: @pre_code,
          current_like: current_like,
          current_bookmark: current_bookmark %>
  </div>

  <%# ===== 登録名 ===== %>
  <section class="-mt-4">
    <h2 class="text-sm font-semibold tracking-wider text-slate-500">登録名</h2>
    <div class="mt-1 rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3">
      <p class="text-base"><%= @pre_code.title %></p>
    </div>
  </section>

  <%# ===== タグ ===== %>
  <section>
    <h2 class="text-sm font-semibold tracking-wider text-slate-500">タグ</h2>
    <div class="mt-1">
      <%= render "shared/tag_pills_static", record: @pre_code %>
    </div>
  </section>

  <%# ===== 説明 ===== %>
  <section>
    <h2 class="text-sm font-semibold tracking-wider text-slate-500">コードの説明</h2>
    <div class="mt-1 rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3">
      <%= simple_format @pre_code.description %>
    </div>
  </section>

  <%# ===== ヒント ===== %>
  <% if @pre_code.hint.present? %>
    <section data-controller="reveal" class="space-y-2">
      <div class="flex items-baseline justify-between">
        <h2 class="text-sm font-semibold tracking-wider text-slate-500">ヒント</h2>
        <button type="button" class="px-3 py-1 rounded ring-1 ring-slate-300 text-sm"
                data-reveal-target="button" data-action="reveal#toggle">表示する</button>
      </div>

      <div class="hidden rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
          data-reveal-target="content">
        <%= sanitize(@pre_code.hint,
                    tags: %w[b i em strong code pre br p ul ol li a],
                    attributes: %w[href]) %>
      </div>
    </section>
  <% end %>

  <%# ===== 登録コード ===== %>
  <section>
    <div class="flex items-baseline justify-between">
      <h2 class="text-sm font-semibold tracking-wider text-slate-500">登録コード</h2>
      <p class="text-xs text-slate-500">
        最終更新日：<%= l @pre_code.updated_at.in_time_zone, format: :ymd_hm %>
      </p>
    </div>

    <style>.cm-editor,.cm-scroller{background:transparent!important}</style>
    <div data-controller="code-view" data-code-view-theme-value="light"
         class="mt-1 rounded-xl ring-1 ring-slate-300 overflow-hidden">
      <textarea data-code-view-target="field" class="hidden"><%= @pre_code.body %></textarea>
      <div data-code-view-target="mount" class="w-full min-h-[120px]"></div>
    </div>
  </section>

  <%# ===== 解答 ===== %>
  <% if @pre_code.answer.present? || @pre_code.answer_code.present? %>
    <section data-controller="reveal" class="space-y-2">
      <div class="flex items-baseline justify-between">
        <h2 class="text-sm font-semibold tracking-wider text-slate-500">解答</h2>
        <button type="button" class="px-3 py-1 rounded ring-1 ring-slate-300 text-sm"
                data-reveal-target="button" data-action="reveal#toggle">表示する</button>
      </div>

      <% if @pre_code.answer.present? %>
        <div class="hidden rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
            data-reveal-target="content">
          <%= sanitize(@pre_code.answer,
                      tags: %w[b i em strong code pre br p ul ol li a],
                      attributes: %w[href]) %>
        </div>
      <% end %>

      <% if @pre_code.answer_code.present? %>
        <div class="hidden" data-reveal-target="content">
          <style>.cm-editor,.cm-scroller{background:transparent!important}</style>
          <div data-controller="code-view" data-code-view-theme-value="light"
              class="rounded-xl ring-1 ring-slate-300 overflow-hidden">
            <textarea data-code-view-target="field" class="hidden"><%= @pre_code.answer_code %></textarea>
            <div data-code-view-target="mount" class="w-full min-h-[120px]"></div>
          </div>
        </div>
      <% end %>
    </section>
  <% end %>

  <%# ===== 最下部：中央に「このデータを利用する」 ===== %>
  <div class="-mt-2 text-center">
    <%= button_to "このデータを利用する",
          used_codes_path(pre_code_id: @pre_code.id,
                          redirect: editor_path(pre_code_id: @pre_code.id)),
          method: :post,
          form: { data: { turbo: false } },
          class: "inline-flex justify-center w-50 sm:w-64 md:w-80 lg:w-96
                  bg-[#CC0000] text-white px-4 py-2 rounded
                  hover:bg-[#BB0000] active:bg-[#AA0000]" %>
  </div>
</div>
