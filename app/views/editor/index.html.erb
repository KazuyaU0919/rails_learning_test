<%# app/views/editor/index.html.erb %>

<% breadcrumb :editor %>
<%= render "shared/breadcrumbs" %>
<% content_for :title, "コードエディタ" %>
<% content_for :page_container_class, "w-full px-2 md:px-4 lg:px-8 py-6" %>

<style>
  .cm-editor, .cm-scroller { background: transparent !important; }
</style>

<div class="w-full space-y-6 bg-white" data-controller="editor loading">
  <h1 class="text-2xl font-semibold"><%= yield :title %></h1>

  <!-- 🔰 初めての方へ（タイトル直下・右寄せ） -->
  <section
    class="-mt-2"
    data-controller="reveal"
    data-reveal-open-label-value="🔰 初めての方へ"
    data-reveal-close-label-value="🔰 説明を閉じる">
    <div class="flex justify-end">
      <button type="button"
              class="px-3 py-1 rounded ring-1 ring-slate-300 text-sm"
              data-reveal-target="button"
              data-action="reveal#toggle">🔰 初めての方へ</button>
    </div>
    <div class="hidden mt-2" data-reveal-target="content">
      <pre class="whitespace-pre-wrap leading-relaxed text-slate-700 bg-white ring-1 ring-slate-200 rounded-xl p-4 text-[15px]">
【はじめに】

Rails Learningへようこそ！
Rails Learningは、Rails初学者やRuby学習者（paiza学習者）のための学習支援アプリです。

Rails初学者の方は、Rails Booksやクイズに挑戦して、Rails に対する知識を学ぶことができます。

Ruby（paiza）学習者の方は、コードエディタ、PreCode、Code Libraryを通して、
学習したrubyコードの意味を覚え、復習 & 実践することができます。

各機能について詳しく知りたい方は、
フッターやハンバーガーメニュー（≡）にある「アプリの使い方」を参照するか、
各機能の上部についている「🔰 初めての方へ」ボタンを押してみましょう。



【コードエディタ機能について】

コードエディタ機能は、オンラインですぐにプログラミング練習ができるRuby限定のコード実行環境です。
WEBブラウザ上で、プログラミング初学者がRubyコードを簡単に実行できる環境を構築しました。

まぁ、細かく説明するよりも、まずは実際に手を動かしてみましょう！

下記のエディタフォームに「puts “Hello World!”」などのRubyコードを入力して、
「実行」ボタンを押してみましょう！

「実行」ボタンを押すと、入力したコードが実行されて、
ページ下部の出力フォームに実行結果が出力されます。

これがコードエディタ機能の基本機能です。
コードエディタ機能を使って、Ruby学習の効率化を行いましょう🎶



【追加機能について】

コードエディタの追加機能についても軽く説明します。


🔸 「テーマ切替」ボタンについて

「実行」ボタンの隣にある「テーマ切替」ボタンを押すと、
エディタフォームの色が白 or 黒に変わります。


🔸 「初期データ選択プルダウン」について

初期データ選択プルダウンについて理解するは、
PreCode画面の「🔰 初めての方へ」の説明を先に読んだ方が良いでしょう。

初期データ選択プルダウンは、
PreCode画面で作成した自分の初期データと、
Code Libraryでブックマーク登録した初期データがプルダウン形式で一覧表示されます。
（作成した初期データがゼロ & ブックマークした初期データがゼロなら何も表示されません）

初期データをプルダウンから選択すると、
エディタフォームに初期データが自動入力されます。

また、選択した初期データが「問題モード」の場合は、
問題タイトル・問題文・ヒント・解答・解答コードも同時に表示されます。
（ヒント・解答・解答コードは最初非表示状態になっております）。


これらの機能を使いこなし、
Ruby学習の効率化を図りましょう！！！
      </pre>
    </div>
  </section>

  <!-- ===== 上部：タイトル／問題文／ヒント ===== -->
  <section data-editor-target="quizPanelTop" class="hidden space-y-4 mt-2">
    <div>
      <h3 class="text-sm font-semibold text-slate-500">タイトル</h3>
      <div class="mt-1 rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
           data-editor-target="quizTitle"></div>
    </div>

    <div>
      <h3 class="text-sm font-semibold text-slate-500">問題文</h3>
      <div class="mt-1 rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
           data-editor-target="quizDesc"></div>
    </div>

    <div data-controller="reveal" class="space-y-2">
      <div class="flex items-baseline justify-between">
        <h3 class="text-sm font-semibold text-slate-500">ヒント</h3>
        <button type="button" class="px-3 py-1 rounded ring-1 ring-slate-300 text-sm"
                data-reveal-target="button" data-action="reveal#toggle">表示する</button>
      </div>
      <div class="hidden rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
           data-reveal-target="content" data-editor-target="quizHint"></div>
    </div>
  </section>

  <!-- ===== CodeMirror（入力欄） ===== -->
  <div data-editor-target="mount"
       class="w-full min-h-[60vh] ring-1 ring-slate-300 overflow-hidden -mt-3">
  </div>

  <!-- ===== 左：初期データ / 右：テーマ切替＆実行 ===== -->
  <div class="flex flex-col md:flex-row md:items-center gap-2 -mt-3">
    <div class="flex items-center gap-2 w-full md:w-auto">
      <label class="text-sm hidden md:inline" for="precode-select">初期データ</label>

      <% if logged_in? %>
        <select id="precode-select"
                data-editor-target="select"
                data-action="change->editor#changeSelect"
                class="w-full md:w-[28rem] px-3 py-2 rounded ring-1 ring-slate-300">
          <option value="">(選択)</option>

          <% if @own_pre_codes.exists? %>
            <optgroup label="自分のデータ">
              <% @own_pre_codes.each do |pc| %>
                <% mode = (pc.answer.present? || pc.answer_code.present?) ? "問題" : "通常" %>
                <option value="<%= pc.id %>">[<%= mode %>] <%= pc.title %></option>
              <% end %>
            </optgroup>
          <% end %>

          <% if @bookmarked_pre_codes.exists? %>
            <optgroup label="ブックマーク">
              <% @bookmarked_pre_codes.each do |pc| %>
                <% mode = (pc.answer.present? || pc.answer_code.present?) ? "問題" : "通常" %>
                <option value="<%= pc.id %>">[BM][<%= mode %>] <%= pc.title %></option>
              <% end %>
            </optgroup>
          <% end %>
        </select>
      <% else %>
        <select id="precode-select"
                class="w-full md:w-[28rem] px-3 py-2 rounded ring-1 ring-slate-300 text-slate-500 cursor-not-allowed"
                disabled>
          <option>(この機能はログイン後に利用できます)</option>
        </select>
      <% end %>
    </div>

    <div class="flex gap-2 pt-2 md:pt-0 md:ml-auto">
      <button type="button"
              data-action="editor#toggleTheme"
              class="px-3 py-2 rounded ring-1 ring-slate-300">
        テーマ切替
      </button>

      <button type="button"
              data-action="editor#run"
              data-editor-target="runButton"
              class="px-3 py-2 rounded bg-[#CC0000] text-white hover:bg-[#BB0000] active:bg-[#AA0000]">
        実行 ▶
      </button>
    </div>
  </div>

  <!-- ===== 実行結果 ===== -->
  <pre data-editor-target="output"
       class="-mt-3 w-full p-3 rounded-none bg-slate-50 ring-1 ring-slate-200 text-sm whitespace-pre-wrap">
  </pre>

  <!-- ===== 下部：解答／解答コード ===== -->
  <section data-editor-target="quizPanelBottom" class="hidden space-y-4 mt-2">
    <div data-controller="reveal" class="space-y-2">
      <div class="flex items-baseline justify-between">
        <h3 class="text-sm font-semibold text-slate-500">解答</h3>
        <button type="button" class="px-3 py-1 rounded ring-1 ring-slate-300 text-sm"
                data-reveal-target="button" data-action="reveal#toggle">表示する</button>
      </div>
      <div class="hidden rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
           data-reveal-target="content" data-editor-target="quizAnswer"></div>
    </div>

    <div data-controller="reveal" class="space-y-2">
      <div class="flex items-baseline justify-between">
        <h3 class="text-sm font-semibold text-slate-500">解答コード</h3>
        <button type="button" class="px-3 py-1 rounded ring-1 ring-slate-300 text-sm"
                data-reveal-target="button" data-action="reveal#toggle">表示する</button>
      </div>

      <div class="hidden" data-reveal-target="content">
        <style>.cm-editor,.cm-scroller{background:transparent!important}</style>
        <div data-controller="code-view" data-code-view-theme-value="light"
             class="rounded-xl ring-1 ring-slate-300 overflow-hidden"
             data-editor-target="quizAnswerCode">
          <textarea data-code-view-target="field" class="hidden"></textarea>
          <div data-code-view-target="mount" class="w-full min-h-[120px]"></div>
        </div>
      </div>
    </div>
  </section>

  <noscript>
    <div class="p-3 rounded bg-amber-50 ring-1 ring-amber-200 text-sm">
      JavaScript を有効にするとエディタを利用できます。
    </div>
  </noscript>
</div>
