<%# app/views/editor/index.html.erb %>

<% breadcrumb :editor %>
<%= render "shared/breadcrumbs" %>
<% content_for :title, "コードエディタ" %>
<% content_for :page_container_class, "w-full px-2 md:px-4 lg:px-8 py-6" %>

<style>
  .cm-editor, .cm-scroller { background: transparent !important; }
</style>

<div class="w-full space-y-6 bg-white" data-controller="editor loading">
  <h1 class="text-2xl font-semibold"><%= yield :title %></h1>

  <!-- ===== 上部：タイトル／問題文／ヒント ===== -->
  <section data-editor-target="quizPanelTop" class="hidden space-y-4 mt-2">
    <div>
      <h3 class="text-sm font-semibold text-slate-500">タイトル</h3>
      <div class="mt-1 rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
           data-editor-target="quizTitle"></div>
    </div>

    <div>
      <h3 class="text-sm font-semibold text-slate-500">問題文</h3>
      <div class="mt-1 rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
           data-editor-target="quizDesc"></div>
    </div>

    <div data-controller="reveal" class="space-y-2">
      <div class="flex items-baseline justify-between">
        <h3 class="text-sm font-semibold text-slate-500">ヒント</h3>
        <button type="button" class="px-3 py-1 rounded ring-1 ring-slate-300 text-sm"
                data-reveal-target="button" data-action="reveal#toggle">表示する</button>
      </div>
      <div class="hidden rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
           data-reveal-target="content" data-editor-target="quizHint"></div>
    </div>
  </section>

  <!-- ===== CodeMirror（入力欄） ===== -->
  <div data-editor-target="mount"
       class="w-full min-h-[60vh] ring-1 ring-slate-300 overflow-hidden -mt-3">
  </div>

  <!-- ===== 左：初期データ / 右：テーマ切替＆実行 ===== -->
  <div class="flex flex-col md:flex-row md:items-center gap-2 -mt-3">
    <div class="flex items-center gap-2 w-full md:w-auto">
      <label class="text-sm hidden md:inline" for="precode-select">初期データ</label>

      <% if logged_in? %>
        <select id="precode-select"
                data-editor-target="select"
                data-action="change->editor#changeSelect"
                class="w-full md:w-[28rem] px-3 py-2 rounded ring-1 ring-slate-300">
          <option value="">(選択)</option>

          <% if @own_pre_codes.exists? %>
            <optgroup label="自分のデータ">
              <% @own_pre_codes.each do |pc| %>
                <% mode = (pc.answer.present? || pc.answer_code.present?) ? "問題" : "通常" %>
                <option value="<%= pc.id %>">[<%= mode %>] <%= pc.title %></option>
              <% end %>
            </optgroup>
          <% end %>

          <% if @bookmarked_pre_codes.exists? %>
            <optgroup label="ブックマーク">
              <% @bookmarked_pre_codes.each do |pc| %>
                <% mode = (pc.answer.present? || pc.answer_code.present?) ? "問題" : "通常" %>
                <option value="<%= pc.id %>">[BM][<%= mode %>] <%= pc.title %></option>
              <% end %>
            </optgroup>
          <% end %>
        </select>
      <% else %>
        <select id="precode-select"
                class="w-full md:w-[28rem] px-3 py-2 rounded ring-1 ring-slate-300 text-slate-500 cursor-not-allowed"
                disabled>
          <option>(この機能はログイン後に利用できます)</option>
        </select>
      <% end %>
    </div>

    <div class="flex gap-2 pt-2 md:pt-0 md:ml-auto">
      <button type="button"
              data-action="editor#toggleTheme"
              class="px-3 py-2 rounded ring-1 ring-slate-300">
        テーマ切替
      </button>

      <button type="button"
              data-action="editor#run"
              data-editor-target="runButton"
              class="px-3 py-2 rounded bg-[#CC0000] text-white hover:bg-[#BB0000] active:bg-[#AA0000]">
        実行 ▶
      </button>
    </div>
  </div>

  <!-- ===== 実行結果 ===== -->
  <pre data-editor-target="output"
       class="-mt-3 w-full p-3 rounded-none bg-slate-50 ring-1 ring-slate-200 text-sm whitespace-pre-wrap">
  </pre>

  <!-- ===== 下部：解答／解答コード ===== -->
  <section data-editor-target="quizPanelBottom" class="hidden space-y-4 mt-2">
    <div data-controller="reveal" class="space-y-2">
      <div class="flex items-baseline justify-between">
        <h3 class="text-sm font-semibold text-slate-500">解答</h3>
        <button type="button" class="px-3 py-1 rounded ring-1 ring-slate-300 text-sm"
                data-reveal-target="button" data-action="reveal#toggle">表示する</button>
      </div>
      <div class="hidden rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
           data-reveal-target="content" data-editor-target="quizAnswer"></div>
    </div>

    <div data-controller="reveal" class="space-y-2">
      <div class="flex items-baseline justify-between">
        <h3 class="text-sm font-semibold text-slate-500">解答コード</h3>
        <button type="button" class="px-3 py-1 rounded ring-1 ring-slate-300 text-sm"
                data-reveal-target="button" data-action="reveal#toggle">表示する</button>
      </div>

      <div class="hidden" data-reveal-target="content">
        <style>.cm-editor,.cm-scroller{background:transparent!important}</style>
        <div data-controller="code-view" data-code-view-theme-value="light"
             class="rounded-xl ring-1 ring-slate-300 overflow-hidden"
             data-editor-target="quizAnswerCode">
          <textarea data-code-view-target="field" class="hidden"></textarea>
          <div data-code-view-target="mount" class="w-full min-h-[120px]"></div>
        </div>
      </div>
    </div>
  </section>

  <noscript>
    <div class="p-3 rounded bg-amber-50 ring-1 ring-amber-200 text-sm">
      JavaScript を有効にするとエディタを利用できます。
    </div>
  </noscript>
</div>
